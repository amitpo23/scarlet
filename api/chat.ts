import type { VercelRequest, VercelResponse } from "@vercel/node";
import OpenAI from "openai";

// Hotel knowledge base for the AI chatbot
const hotelKnowledge = `
# Scarlet Hotel Tel Aviv - ××™×“×¢ ××œ×

## ××™×“×¢ ×›×œ×œ×™
- ×©×: ××œ×•×Ÿ Scarlet ×ª×œ ××‘×™×‘
- ×›×ª×•×‘×ª: ×¨×—×•×‘ ×–'×‘×•×˜×™× ×¡×§×™ 17, ×ª×œ ××‘×™×‘
- ×˜×œ×¤×•×Ÿ: +972-3-123-4567
- ××™××™×™×œ: info@scarlethotel.co.il
- ×“×™×¨×•×’: 4.7/5 (××‘×•×¡×¡ ×¢×œ 328 ×‘×™×§×•×¨×•×ª)
- ××™×§×•×: 9.4/10 - ××™×§×•× ××¢×•×œ×”

## ×¡×•×’×™ ×—×“×¨×™× ×•××—×™×¨×™×

### ×—×“×¨ ××§×•× ×•××™ ×–×•×’×™
- ×ª×™××•×¨: ×—×“×¨ × ×¢×™× ×•××¢×•×¦×‘ ×‘×§×¤×™×“×” ×¢× ×›×œ ×”×©×™×¨×•×ª×™× ×”×“×¨×•×©×™× ×œ×©×”×™×™×” × ×•×—×”
- ××ª××™× ×œ: ×–×•×’×•×ª, × ×•×¡×¢×™× ×¢×¡×§×™×™×
- ××—×™×¨ ××©×•×¢×¨: ×”×—×œ ×-â‚ª450 ×œ×œ×™×œ×”

### ×—×“×¨ ×§×œ××¡×™×§ ×–×•×’×™
- ×ª×™××•×¨: ×—×“×¨ ××¨×•×•×— ×¢× ×¢×™×¦×•×‘ ×™×™×—×•×“×™ ×•××•×•×™×¨×” ×—××™××”
- ××ª××™× ×œ: ×–×•×’×•×ª ×”××—×¤×©×™× ×™×•×ª×¨ ××§×•×
- ××—×™×¨ ××©×•×¢×¨: ×”×—×œ ×-â‚ª550 ×œ×œ×™×œ×”

### ×—×“×¨ ×§×œ××¡×™×§ ×–×•×’×™ ×¢× ××¨×¤×¡×ª
- ×ª×™××•×¨: ×—×“×¨ ×§×œ××¡×™ ×¢× ××¨×¤×¡×ª ×¤×¨×˜×™×ª ×•× ×•×£ ×œ×¢×™×¨
- ××ª××™× ×œ: ×–×•×’×•×ª ×©×¨×•×¦×™× ××¨×¤×¡×ª ×¤×¨×˜×™×ª
- ××—×™×¨ ××©×•×¢×¨: ×”×—×œ ×-â‚ª650 ×œ×œ×™×œ×”

### ×—×“×¨ ×“×œ×•×§×¡
- ×ª×™××•×¨: ×—×“×¨ ×™×•×§×¨×ª×™ ×¢× ×¢×™×¦×•×‘ × ×•×¢×– ×•××¨×©×™× ×‘×’×•×•× ×™× ××“×•××™×
- ××ª××™× ×œ: ×–×•×’×•×ª ×”××—×¤×©×™× ×—×•×•×™×” ×™×•×§×¨×ª×™×ª
- ××—×™×¨ ××©×•×¢×¨: ×”×—×œ ×-â‚ª850 ×œ×œ×™×œ×”

## ×©×™×¨×•×ª×™× ×•××ª×§× ×™×
- Wi-Fi ×—×™× × ×‘×›×œ ×¨×—×‘×™ ×”××œ×•×Ÿ
- ××™×–×•×’ ××•×•×™×¨ ×‘×›×œ ×”×—×“×¨×™×
- ×‘×¨ ×•××¡×¢×“×”
- ×—× ×™×” (×‘×ª×©×œ×•× × ×•×¡×£)
- ×›×¡×¤×ª ×‘×›×œ ×—×“×¨
- ×©×™×¨×•×ª ×§×•× ×¡×™×™×¨×–' 24/7
- ××¨×•×Ÿ ×‘×’×“×™× ××¨×•×•×—
- ×§×•××§×•× ×—×©××œ×™
- ××§×¨×¨
- ×˜×œ×•×•×™×–×™×” ×‘×¢×œ×ª ××¡×š ×©×˜×•×—
- ×—×“×¨ ×¨×—×¦×” ×¤×¨×˜×™ ×¢× ××§×œ×—×ª
- ××™×™×‘×© ×©×™×¢×¨
- ××¦×¢×™× ×•××’×‘×•×ª ××™×›×•×ª×™×™×

## ××“×™× ×™×•×ª ×”××œ×•×Ÿ

### ×¦'×§-××™×Ÿ ×•×¦'×§-×××•×˜
- ×¦'×§-××™×Ÿ: ×”×—×œ ×-15:00
- ×¦'×§-×××•×˜: ×¢×“ 11:00
- × ×™×ª×Ÿ ×œ×‘×§×© ×¦'×§-××™×Ÿ ××•×§×“× ××• ×¦'×§-×××•×˜ ×××•×—×¨ (×‘×›×¤×•×£ ×œ×–××™× ×•×ª)

### ××¨×•×—×ª ×‘×•×§×¨
- ××¨×•×—×ª ×‘×•×§×¨ ×–××™× ×” ×‘×ª×•×¡×¤×ª ×ª×©×œ×•×
- ×©×¢×•×ª ×”×’×©×”: 07:00-10:30
- ××—×™×¨: â‚ª65 ×œ××“×

### ×—× ×™×”
- ×—× ×™×” ×–××™× ×” ×‘×ª×©×œ×•× × ×•×¡×£
- ××—×™×¨: â‚ª50 ×œ×™×•×

### ×—×™×•×ª ××—××“
- ×œ× ××•×ª×¨ ×œ×”×‘×™× ×—×™×•×ª ××—××“

### ×‘×™×˜×•×œ×™×
- ×‘×™×˜×•×œ ×—×™× × ×¢×“ 48 ×©×¢×•×ª ×œ×¤× ×™ ×”×”×’×¢×”
- ×‘×™×˜×•×œ ×××•×—×¨ ×™×•×ª×¨ ×¢×©×•×™ ×œ×’×¨×•×¨ ×—×™×•×‘ ×©×œ ×œ×™×œ×” ××—×“

### ×ª×©×œ×•×
- ××§×‘×œ×™× ×›×¨×˜×™×¡×™ ××©×¨××™: Visa, Mastercard, American Express
- × ×™×ª×Ÿ ×œ×©×œ× ×‘××–×•××Ÿ
- ×”×ª×©×œ×•× ××ª×‘×¦×¢ ×‘×¢×ª ×”×¦'×§-××™×Ÿ ××• ×”×¦'×§-×××•×˜

## ××™×§×•× ×•××˜×¨×§×¦×™×•×ª ×‘×§×¨×‘×ª ××§×•×

### ××¨×—×§ ×× ×§×•×“×•×ª ×¢× ×™×™×Ÿ
- ×—×•×£ ×’×•×¨×“×•×Ÿ: 500 ××˜×¨ (5 ×“×§×•×ª ×”×œ×™×›×”)
- ×›×™×›×¨ ×“×™×–× ×’×•×£: 800 ××˜×¨ (10 ×“×§×•×ª ×”×œ×™×›×”)
- ×“×™×–× ×’×•×£ ×¡× ×˜×¨: 1.2 ×§"× (15 ×“×§×•×ª ×”×œ×™×›×”)
- ×©×•×§ ×”×›×¨××œ: 1.5 ×§"× (18 ×“×§×•×ª ×”×œ×™×›×”)
- ××•×–×™××•×Ÿ ×ª×œ ××‘×™×‘ ×œ××× ×•×ª: 1.8 ×§"× (22 ×“×§×•×ª ×”×œ×™×›×”)
- ×©×“×¨×•×ª ×¨×•×˜×©×™×œ×“: 2 ×§"× (25 ×“×§×•×ª ×”×œ×™×›×”)
- ×™×¤×• ×”×¢×ª×™×§×”: 4 ×§"× (10 ×“×§×•×ª × ×¡×™×¢×”)
- ×©×•×§ ×¡×¨×•× ×”: 2.5 ×§"× (30 ×“×§×•×ª ×”×œ×™×›×”)

### ×ª×—×‘×•×¨×” ×¦×™×‘×•×¨×™×ª
- ×ª×—× ×ª ××•×˜×•×‘×•×¡: 100 ××˜×¨ ××”××œ×•×Ÿ
- ×¨×›×‘×ª - ×ª×—× ×ª ××•× ×™×‘×¨×¡×™×˜×”: 2 ×§"×
- × ××œ ×”×ª×¢×•×¤×” ×‘×Ÿ ×’×•×¨×™×•×Ÿ: 20 ×§"× (×›-30 ×“×§×•×ª × ×¡×™×¢×”)

## ×”×¦×¢×•×ª ××™×•×—×“×•×ª

### ×”×–×× ×” ××•×§×“××ª (30% ×”× ×—×”)
- ×”×–××Ÿ 30 ×™××™× ××¨××© ×•×—×¡×•×š ×‘×—×•×£ ×©×œ× ×•
- ×ª×§×£ ×¢×“: 31.12.2025
- ×›×•×œ×œ: ×‘×™×˜×•×œ ×—×™× × ×¢×“ 7 ×™××™× ×œ×¤× ×™, WiFi ××”×™×¨, ×©×™×¨×•×ª ×§×•× ×¡×™×™×¨×–' 24/7

### ×—×‘×™×œ×” ×¨×•×× ×˜×™×ª (20% ×”× ×—×”)
- ×—×‘×™×œ×” ××©×•×œ××ª ×œ×–×•×’×•×ª - ×—×“×¨ ××¢×•×¦×‘, ×©××¤× ×™×” ×•××¨×•×—×ª ×¢×¨×‘ ×¨×•×× ×˜×™×ª
- ×ª×§×£: ×›×œ ×”×©× ×”
- ×›×•×œ×œ: ×‘×§×‘×•×§ ×©××¤× ×™×” ×‘×—×“×¨, ×¤×¨×—×™× ×˜×¨×™×™×, ××¨×•×—×ª ×¢×¨×‘ ×‘××¡×¢×“×” ××•××œ×¦×ª

### ×—×‘×™×œ×ª ×§×™×¥ ××™×•×—×“×ª (25% ×”× ×—×”)
- ×—×‘×™×œ×ª ×§×™×¥ ××¤× ×§×ª ×‘×ª×œ ××‘×™×‘ ×¢× ×—×‘×™×œ×” ××™×•×—×“×ª ×¢×œ ×©×”×™×™×ª ×©×œ 3 ×œ×™×œ×•×ª ×•××¢×œ×”
- ×ª×§×£ ×¢×“: 31.8.2025
- ×›×•×œ×œ: ××¨×•×—×ª ×‘×•×§×¨ ×—×™× ×, ×©×“×¨×•×’ ×—×“×¨ ×‘×›×¤×•×£ ×œ×–××™× ×•×ª, ×¦'×§-×××•×˜ ×××•×—×¨ ×¢×“ 14:00

## ×©××œ×•×ª × ×¤×•×¦×•×ª

### ×”×× ×™×© ××™× ×˜×¨× ×˜ ××œ×—×•×˜×™ ×—×™× ×?
×›×Ÿ, ×™×© Wi-Fi ×—×™× × ×‘×›×œ ×¨×—×‘×™ ×”××œ×•×Ÿ.

### ×›××” ×¨×—×•×§ ×”××œ×•×Ÿ ××”×—×•×£?
×”××œ×•×Ÿ × ××¦× 500 ××˜×¨ (5 ×“×§×•×ª ×”×œ×™×›×”) ××—×•×£ ×’×•×¨×“×•×Ÿ.

### ××™×š ××’×™×¢×™× ×× ××œ ×”×ª×¢×•×¤×” ×œ××œ×•×Ÿ?
× ×™×ª×Ÿ ×œ×”×’×™×¢ ×‘××•× ×™×ª (×›-30 ×“×§×•×ª), ×‘×¨×›×‘×ª ×œ×ª×—× ×ª ××•× ×™×‘×¨×¡×™×˜×” ×•××©× ××•× ×™×ª ×§×¦×¨×”, ××• ×‘××•×˜×•×‘×•×¡.

### ×”×× ×”××œ×•×Ÿ ××ª××™× ×œ××©×¤×—×•×ª?
×”××œ×•×Ÿ ××ª××™× ×‘×¢×™×§×¨ ×œ×–×•×’×•×ª ×•× ×•×¡×¢×™× ×¢×¡×§×™×™×. ×”×—×“×¨×™× ××ª××™××™× ×œ-2 ×× ×©×™×.

### ×”×× ×™×© ××¡×¢×“×” ×‘××œ×•×Ÿ?
×›×Ÿ, ×™×© ×‘×¨ ×•××¡×¢×“×” ×‘××œ×•×Ÿ. ××¨×•×—×ª ×‘×•×§×¨ ×–××™× ×” ×‘×ª×•×¡×¤×ª ×ª×©×œ×•×.

### ×”×× × ×™×ª×Ÿ ×œ×‘×˜×œ ×”×–×× ×”?
×›×Ÿ, × ×™×ª×Ÿ ×œ×‘×˜×œ ×—×™× × ×¢×“ 48 ×©×¢×•×ª ×œ×¤× ×™ ×”×”×’×¢×”. ×‘×™×˜×•×œ ×××•×—×¨ ×™×•×ª×¨ ×¢×©×•×™ ×œ×’×¨×•×¨ ×—×™×•×‘.

## ×¦×•×¨ ×§×©×¨
- ×˜×œ×¤×•×Ÿ: +972-3-123-4567
- ××™××™×™×œ: info@scarlethotel.co.il
- ×”×–×× ×•×ª: reservations@scarlethotel.co.il
- WhatsApp: +972-50-123-4567
- ××ª×¨: www.scarlethotel.co.il
- Instagram: @scarlet_hoteltlv
- Facebook: /scarlethoteltlv
- ×©×¢×•×ª ×¤×¢×™×œ×•×ª: 24/7

## ××™×“×¢ × ×•×¡×£
- ×”××œ×•×Ÿ × ××¦× ×‘×‘× ×™×™×Ÿ ×”×™×¡×˜×•×¨×™ ××©×•×¤×¥
- ×¢×™×¦×•×‘ ×‘×•×˜×™×§×™ ×™×™×—×•×“×™ ×¢× ×’×•×•× ×™× ××“×•××™×
- ××•×•×™×¨×” ××™× ×˜×™××™×ª ×•××™×•×—×“×ª
- ×¦×•×•×ª ×“×•×‘×¨ ×¢×‘×¨×™×ª, ×× ×’×œ×™×ª, ×¨×•×¡×™×ª
- ××ª××™× ×‘××™×•×—×“ ×œ×–×•×’×•×ª ×•× ×•×¡×¢×™× ×¢×¡×§×™×™×
- ×§×¨×•×‘ ×œ×—×™×™ ×”×œ×™×œ×” ×”×ª×•×¡×¡×™× ×©×œ ×ª×œ ××‘×™×‘
`;

const systemPrompt = `××ª×” ×¢×•×–×¨ AI ×—×›× ×•××§×¦×•×¢×™ ×©×œ ××œ×•×Ÿ Scarlet ×ª×œ ××‘×™×‘.

×ª×¤×§×™×“×š:
- ×œ×¢× ×•×ª ×¢×œ ×©××œ×•×ª ××•×¨×—×™× ×‘×¦×•×¨×” ×™×“×™×“×•×ª×™×ª ×•××§×¦×•×¢×™×ª
- ×œ×¡×¤×§ ××™×“×¢ ××“×•×™×§ ×¢×œ ×”××œ×•×Ÿ, ×”×—×“×¨×™×, ×”××—×™×¨×™× ×•×”×©×™×¨×•×ª×™×
- ×œ×¢×–×•×¨ ×‘××•×¨×—×™× ×œ×‘×—×•×¨ ××ª ×”×—×“×¨ ×”××ª××™× ×œ×”×
- ×œ×¢×•×“×“ ×”×–×× ×•×ª ×•×œ×¡×¤×§ ×§×™×©×•×¨ ×œ×”×–×× ×”
- ×œ×¢× ×•×ª ×‘×¢×‘×¨×™×ª ××• ×‘×× ×’×œ×™×ª ×‘×”×ª×× ×œ×©×¤×ª ×”×©×•××œ

×”× ×—×™×•×ª:
- ×ª××™×“ ×”×™×” ××“×™×‘, ××§×¦×•×¢×™ ×•×™×“×™×“×•×ª×™
- ×”×©×ª××© ×‘××™×“×¢ ××”-knowledge base ×‘×œ×‘×“
- ×× ××ª×” ×œ× ×™×•×“×¢ ××©×”×•, ×××•×¨ ×©×ª×‘×“×•×§ ×•×ª×—×–×•×¨ ×¢× ×ª×©×•×‘×”
- ×¢×•×“×“ ×”×–×× ×•×ª ××‘×œ ××œ ×ª×”×™×” ×œ×•×—×¥ ××“×™
- ×”×©×ª××© ×‘××™××•×’'×™ ×‘××™×“×” (×œ× ×™×•×ª×¨ ××“×™)
- ×ª×Ÿ ×ª×©×•×‘×•×ª ×§×¦×¨×•×ª ×•×××•×§×“×•×ª
- ×× ×©×•××œ×™× ×¢×œ ××—×™×¨, ×¦×™×™×Ÿ "×”×—×œ ×-" ×•×¢×•×“×“ ×œ×™×¦×•×¨ ×§×©×¨ ×œ×¤×¨×˜×™× ××“×•×™×§×™×

×“×•×’×××•×ª ×œ×ª×©×•×‘×•×ª ×˜×•×‘×•×ª:
- "×©×œ×•×! ğŸ‘‹ ××©××— ×œ×¢×–×•×¨ ×œ×š ×œ××¦×•× ××ª ×”×—×“×¨ ×”××•×©×œ× ×‘××œ×•×Ÿ Scarlet"
- "×”××œ×•×Ÿ ×©×œ× ×• × ××¦× ×‘××™×§×•× ××¢×•×œ×”, ×¨×§ 5 ×“×§×•×ª ×”×œ×™×›×” ××—×•×£ ×’×•×¨×“×•×Ÿ ğŸ–ï¸"
- "×”×—×“×¨ ×”×§×œ××¡×™×§ ×¢× ××¨×¤×¡×ª ××ª×—×™×œ ×-â‚ª650 ×œ×œ×™×œ×”. ×¨×•×¦×” ×©××¢×–×•×¨ ×œ×š ×œ×”×–××™×Ÿ?"

×–×›×•×¨: ××ª×” ××™×™×¦×’ ××ª ×”××œ×•×Ÿ, ××– ×ª××™×“ ×”×™×” ×—×™×•×‘×™ ×•××•×¢×™×œ!`;

export default async function handler(req: VercelRequest, res: VercelResponse) {
  // Only allow POST requests
  if (req.method !== "POST") {
    return res.status(405).json({ error: "Method not allowed" });
  }

  try {
    const apiKey = process.env.OPENAI_API_KEY;
    if (!apiKey) {
      return res.status(500).json({
        error: "API key not configured",
        message: "××¤×ª×— API ×œ× ×”×•×’×“×¨. ×× × ×¤× ×” ×œ×× ×”×œ ×”××ª×¨.",
      });
    }

    const { messages, userMessage } = req.body;

    if (!userMessage) {
      return res.status(400).json({
        error: "Missing message",
        message: "×—×¡×¨×” ×”×•×“×¢×”",
      });
    }

    const openai = new OpenAI({ apiKey });

    const response = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [
        {
          role: "system",
          content: systemPrompt + "\n\nKnowledge Base:\n" + hotelKnowledge,
        },
        ...(messages || []).map((msg: { role: string; content: string }) => ({
          role: msg.role as "user" | "assistant",
          content: msg.content,
        })),
        {
          role: "user",
          content: userMessage,
        },
      ],
      temperature: 0.7,
      max_tokens: 500,
    });

    const assistantMessage =
      response.choices[0]?.message?.content ||
      "××¦×˜×¢×¨, ×œ× ×”×¦×œ×—×ª×™ ×œ×”×‘×™×Ÿ. × ×¡×” ×©×•×‘.";

    return res.status(200).json({ message: assistantMessage });
  } catch (err: any) {
    console.error("Chat API error:", err);

    let errorMessage = "××¦×˜×¢×¨, ××™×¨×¢×” ×©×’×™××”. ×× × × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.";

    if (err.status === 429) {
      errorMessage = "×™×•×ª×¨ ××“×™ ×‘×§×©×•×ª. ×× × ×”××ª×Ÿ ×¨×’×¢ ×•× ×¡×” ×©×•×‘.";
    } else if (err.status === 401) {
      errorMessage = "××¤×ª×— API ×œ× ×ª×§×™×Ÿ. ×× × ×¤× ×” ×œ×× ×”×œ ×”××ª×¨.";
    }

    return res.status(err.status || 500).json({
      error: err.message,
      message: errorMessage,
    });
  }
}
