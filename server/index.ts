import express from "express";
import { createServer } from "http";
import path from "path";
import { fileURLToPath } from "url";
import OpenAI from "openai";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Hotel knowledge base for the AI chatbot
const hotelKnowledge = `
# Scarlet Hotel Tel Aviv - ×ž×™×“×¢ ×ž×œ×

## ×ž×™×“×¢ ×›×œ×œ×™
- ×©×: ×ž×œ×•×Ÿ Scarlet ×ª×œ ××‘×™×‘
- ×›×ª×•×‘×ª: ×¨×—×•×‘ ×–'×‘×•×˜×™× ×¡×§×™ 17, ×ª×œ ××‘×™×‘
- ×˜×œ×¤×•×Ÿ: +972-3-123-4567
- ××™×ž×™×™×œ: info@scarlethotel.co.il
- ×“×™×¨×•×’: 4.7/5 (×ž×‘×•×¡×¡ ×¢×œ 328 ×‘×™×§×•×¨×•×ª)
- ×ž×™×§×•×: 9.4/10 - ×ž×™×§×•× ×ž×¢×•×œ×”

## ×¡×•×’×™ ×—×“×¨×™× ×•×ž×—×™×¨×™×

### ×—×“×¨ ××§×•× ×•×ž×™ ×–×•×’×™
- ×ª×™××•×¨: ×—×“×¨ × ×¢×™× ×•×ž×¢×•×¦×‘ ×‘×§×¤×™×“×” ×¢× ×›×œ ×”×©×™×¨×•×ª×™× ×”×“×¨×•×©×™× ×œ×©×”×™×™×” × ×•×—×”
- ×ž×ª××™× ×œ: ×–×•×’×•×ª, × ×•×¡×¢×™× ×¢×¡×§×™×™×
- ×ž×—×™×¨ ×ž×©×•×¢×¨: ×”×—×œ ×ž-â‚ª450 ×œ×œ×™×œ×”

### ×—×“×¨ ×§×œ××¡×™×§ ×–×•×’×™
- ×ª×™××•×¨: ×—×“×¨ ×ž×¨×•×•×— ×¢× ×¢×™×¦×•×‘ ×™×™×—×•×“×™ ×•××•×•×™×¨×” ×—×ž×™×ž×”
- ×ž×ª××™× ×œ: ×–×•×’×•×ª ×”×ž×—×¤×©×™× ×™×•×ª×¨ ×ž×§×•×
- ×ž×—×™×¨ ×ž×©×•×¢×¨: ×”×—×œ ×ž-â‚ª550 ×œ×œ×™×œ×”

### ×—×“×¨ ×§×œ××¡×™×§ ×–×•×’×™ ×¢× ×ž×¨×¤×¡×ª
- ×ª×™××•×¨: ×—×“×¨ ×§×œ××¡×™ ×¢× ×ž×¨×¤×¡×ª ×¤×¨×˜×™×ª ×•× ×•×£ ×œ×¢×™×¨
- ×ž×ª××™× ×œ: ×–×•×’×•×ª ×©×¨×•×¦×™× ×ž×¨×¤×¡×ª ×¤×¨×˜×™×ª
- ×ž×—×™×¨ ×ž×©×•×¢×¨: ×”×—×œ ×ž-â‚ª650 ×œ×œ×™×œ×”

### ×—×“×¨ ×“×œ×•×§×¡
- ×ª×™××•×¨: ×—×“×¨ ×™×•×§×¨×ª×™ ×¢× ×¢×™×¦×•×‘ × ×•×¢×– ×•×ž×¨×©×™× ×‘×’×•×•× ×™× ××“×•×ž×™×
- ×ž×ª××™× ×œ: ×–×•×’×•×ª ×”×ž×—×¤×©×™× ×—×•×•×™×” ×™×•×§×¨×ª×™×ª
- ×ž×—×™×¨ ×ž×©×•×¢×¨: ×”×—×œ ×ž-â‚ª850 ×œ×œ×™×œ×”

## ×©×™×¨×•×ª×™× ×•×ž×ª×§× ×™×
- Wi-Fi ×—×™× × ×‘×›×œ ×¨×—×‘×™ ×”×ž×œ×•×Ÿ
- ×ž×™×–×•×’ ××•×•×™×¨ ×‘×›×œ ×”×—×“×¨×™×
- ×‘×¨ ×•×ž×¡×¢×“×”
- ×—× ×™×” (×‘×ª×©×œ×•× × ×•×¡×£)
- ×›×¡×¤×ª ×‘×›×œ ×—×“×¨
- ×©×™×¨×•×ª ×§×•× ×¡×™×™×¨×–' 24/7
- ××¨×•×Ÿ ×‘×’×“×™× ×ž×¨×•×•×—
- ×§×•×ž×§×•× ×—×©×ž×œ×™
- ×ž×§×¨×¨
- ×˜×œ×•×•×™×–×™×” ×‘×¢×œ×ª ×ž×¡×š ×©×˜×•×—
- ×—×“×¨ ×¨×—×¦×” ×¤×¨×˜×™ ×¢× ×ž×§×œ×—×ª
- ×ž×™×™×‘×© ×©×™×¢×¨
- ×ž×¦×¢×™× ×•×ž×’×‘×•×ª ××™×›×•×ª×™×™×

## ×ž×“×™× ×™×•×ª ×”×ž×œ×•×Ÿ

### ×¦'×§-××™×Ÿ ×•×¦'×§-×××•×˜
- ×¦'×§-××™×Ÿ: ×”×—×œ ×ž-15:00
- ×¦'×§-×××•×˜: ×¢×“ 11:00
- × ×™×ª×Ÿ ×œ×‘×§×© ×¦'×§-××™×Ÿ ×ž×•×§×“× ××• ×¦'×§-×××•×˜ ×ž××•×—×¨ (×‘×›×¤×•×£ ×œ×–×ž×™× ×•×ª)

### ××¨×•×—×ª ×‘×•×§×¨
- ××¨×•×—×ª ×‘×•×§×¨ ×–×ž×™× ×” ×‘×ª×•×¡×¤×ª ×ª×©×œ×•×
- ×©×¢×•×ª ×”×’×©×”: 07:00-10:30
- ×ž×—×™×¨: â‚ª65 ×œ××“×

### ×—× ×™×”
- ×—× ×™×” ×–×ž×™× ×” ×‘×ª×©×œ×•× × ×•×¡×£
- ×ž×—×™×¨: â‚ª50 ×œ×™×•×

### ×—×™×•×ª ×ž×—×ž×“
- ×œ× ×ž×•×ª×¨ ×œ×”×‘×™× ×—×™×•×ª ×ž×—×ž×“

### ×‘×™×˜×•×œ×™×
- ×‘×™×˜×•×œ ×—×™× × ×¢×“ 48 ×©×¢×•×ª ×œ×¤× ×™ ×”×”×’×¢×”
- ×‘×™×˜×•×œ ×ž××•×—×¨ ×™×•×ª×¨ ×¢×©×•×™ ×œ×’×¨×•×¨ ×—×™×•×‘ ×©×œ ×œ×™×œ×” ××—×“

### ×ª×©×œ×•×
- ×ž×§×‘×œ×™× ×›×¨×˜×™×¡×™ ××©×¨××™: Visa, Mastercard, American Express
- × ×™×ª×Ÿ ×œ×©×œ× ×‘×ž×–×•×ž×Ÿ
- ×”×ª×©×œ×•× ×ž×ª×‘×¦×¢ ×‘×¢×ª ×”×¦'×§-××™×Ÿ ××• ×”×¦'×§-×××•×˜

## ×ž×™×§×•× ×•××˜×¨×§×¦×™×•×ª ×‘×§×¨×‘×ª ×ž×§×•×

### ×ž×¨×—×§ ×ž× ×§×•×“×•×ª ×¢× ×™×™×Ÿ
- ×—×•×£ ×’×•×¨×“×•×Ÿ: 500 ×ž×˜×¨ (5 ×“×§×•×ª ×”×œ×™×›×”)
- ×›×™×›×¨ ×“×™×–× ×’×•×£: 800 ×ž×˜×¨ (10 ×“×§×•×ª ×”×œ×™×›×”)
- ×“×™×–× ×’×•×£ ×¡× ×˜×¨: 1.2 ×§"×ž (15 ×“×§×•×ª ×”×œ×™×›×”)
- ×©×•×§ ×”×›×¨×ž×œ: 1.5 ×§"×ž (18 ×“×§×•×ª ×”×œ×™×›×”)
- ×ž×•×–×™××•×Ÿ ×ª×œ ××‘×™×‘ ×œ××ž× ×•×ª: 1.8 ×§"×ž (22 ×“×§×•×ª ×”×œ×™×›×”)
- ×©×“×¨×•×ª ×¨×•×˜×©×™×œ×“: 2 ×§"×ž (25 ×“×§×•×ª ×”×œ×™×›×”)
- ×™×¤×• ×”×¢×ª×™×§×”: 4 ×§"×ž (10 ×“×§×•×ª × ×¡×™×¢×”)
- ×©×•×§ ×¡×¨×•× ×”: 2.5 ×§"×ž (30 ×“×§×•×ª ×”×œ×™×›×”)

### ×ª×—×‘×•×¨×” ×¦×™×‘×•×¨×™×ª
- ×ª×—× ×ª ××•×˜×•×‘×•×¡: 100 ×ž×˜×¨ ×ž×”×ž×œ×•×Ÿ
- ×¨×›×‘×ª - ×ª×—× ×ª ××•× ×™×‘×¨×¡×™×˜×”: 2 ×§"×ž
- × ×ž×œ ×”×ª×¢×•×¤×” ×‘×Ÿ ×’×•×¨×™×•×Ÿ: 20 ×§"×ž (×›-30 ×“×§×•×ª × ×¡×™×¢×”)

## ×”×¦×¢×•×ª ×ž×™×•×—×“×•×ª

### ×”×–×ž× ×” ×ž×•×§×“×ž×ª (30% ×”× ×—×”)
- ×”×–×ž×Ÿ 30 ×™×ž×™× ×ž×¨××© ×•×—×¡×•×š ×‘×—×•×£ ×©×œ× ×•
- ×ª×§×£ ×¢×“: 31.12.2025
- ×›×•×œ×œ: ×‘×™×˜×•×œ ×—×™× × ×¢×“ 7 ×™×ž×™× ×œ×¤× ×™, WiFi ×ž×”×™×¨, ×©×™×¨×•×ª ×§×•× ×¡×™×™×¨×–' 24/7

### ×—×‘×™×œ×” ×¨×•×ž× ×˜×™×ª (20% ×”× ×—×”)
- ×—×‘×™×œ×” ×ž×©×•×œ×ž×ª ×œ×–×•×’×•×ª - ×—×“×¨ ×ž×¢×•×¦×‘, ×©×ž×¤× ×™×” ×•××¨×•×—×ª ×¢×¨×‘ ×¨×•×ž× ×˜×™×ª
- ×ª×§×£: ×›×œ ×”×©× ×”
- ×›×•×œ×œ: ×‘×§×‘×•×§ ×©×ž×¤× ×™×” ×‘×—×“×¨, ×¤×¨×—×™× ×˜×¨×™×™×, ××¨×•×—×ª ×¢×¨×‘ ×‘×ž×¡×¢×“×” ×ž×•×ž×œ×¦×ª

### ×—×‘×™×œ×ª ×§×™×¥ ×ž×™×•×—×“×ª (25% ×”× ×—×”)
- ×—×‘×™×œ×ª ×§×™×¥ ×ž×¤× ×§×ª ×‘×ª×œ ××‘×™×‘ ×¢× ×—×‘×™×œ×” ×ž×™×•×—×“×ª ×¢×œ ×©×”×™×™×ª ×©×œ 3 ×œ×™×œ×•×ª ×•×ž×¢×œ×”
- ×ª×§×£ ×¢×“: 31.8.2025
- ×›×•×œ×œ: ××¨×•×—×ª ×‘×•×§×¨ ×—×™× ×, ×©×“×¨×•×’ ×—×“×¨ ×‘×›×¤×•×£ ×œ×–×ž×™× ×•×ª, ×¦'×§-×××•×˜ ×ž××•×—×¨ ×¢×“ 14:00

## ×©××œ×•×ª × ×¤×•×¦×•×ª

### ×”×× ×™×© ××™× ×˜×¨× ×˜ ××œ×—×•×˜×™ ×—×™× ×?
×›×Ÿ, ×™×© Wi-Fi ×—×™× × ×‘×›×œ ×¨×—×‘×™ ×”×ž×œ×•×Ÿ.

### ×›×ž×” ×¨×—×•×§ ×”×ž×œ×•×Ÿ ×ž×”×—×•×£?
×”×ž×œ×•×Ÿ × ×ž×¦× 500 ×ž×˜×¨ (5 ×“×§×•×ª ×”×œ×™×›×”) ×ž×—×•×£ ×’×•×¨×“×•×Ÿ.

### ××™×š ×ž×’×™×¢×™× ×ž× ×ž×œ ×”×ª×¢×•×¤×” ×œ×ž×œ×•×Ÿ?
× ×™×ª×Ÿ ×œ×”×’×™×¢ ×‘×ž×•× ×™×ª (×›-30 ×“×§×•×ª), ×‘×¨×›×‘×ª ×œ×ª×—× ×ª ××•× ×™×‘×¨×¡×™×˜×” ×•×ž×©× ×ž×•× ×™×ª ×§×¦×¨×”, ××• ×‘××•×˜×•×‘×•×¡.

### ×”×× ×”×ž×œ×•×Ÿ ×ž×ª××™× ×œ×ž×©×¤×—×•×ª?
×”×ž×œ×•×Ÿ ×ž×ª××™× ×‘×¢×™×§×¨ ×œ×–×•×’×•×ª ×•× ×•×¡×¢×™× ×¢×¡×§×™×™×. ×”×—×“×¨×™× ×ž×ª××™×ž×™× ×œ-2 ×× ×©×™×.

### ×”×× ×™×© ×ž×¡×¢×“×” ×‘×ž×œ×•×Ÿ?
×›×Ÿ, ×™×© ×‘×¨ ×•×ž×¡×¢×“×” ×‘×ž×œ×•×Ÿ. ××¨×•×—×ª ×‘×•×§×¨ ×–×ž×™× ×” ×‘×ª×•×¡×¤×ª ×ª×©×œ×•×.

### ×”×× × ×™×ª×Ÿ ×œ×‘×˜×œ ×”×–×ž× ×”?
×›×Ÿ, × ×™×ª×Ÿ ×œ×‘×˜×œ ×—×™× × ×¢×“ 48 ×©×¢×•×ª ×œ×¤× ×™ ×”×”×’×¢×”. ×‘×™×˜×•×œ ×ž××•×—×¨ ×™×•×ª×¨ ×¢×©×•×™ ×œ×’×¨×•×¨ ×—×™×•×‘.

## ×¦×•×¨ ×§×©×¨
- ×˜×œ×¤×•×Ÿ: +972-3-123-4567
- ××™×ž×™×™×œ: info@scarlethotel.co.il
- ×”×–×ž× ×•×ª: reservations@scarlethotel.co.il
- WhatsApp: +972-50-123-4567
- ××ª×¨: www.scarlethotel.co.il
- Instagram: @scarlet_hoteltlv
- Facebook: /scarlethoteltlv
- ×©×¢×•×ª ×¤×¢×™×œ×•×ª: 24/7

## ×ž×™×“×¢ × ×•×¡×£
- ×”×ž×œ×•×Ÿ × ×ž×¦× ×‘×‘× ×™×™×Ÿ ×”×™×¡×˜×•×¨×™ ×ž×©×•×¤×¥
- ×¢×™×¦×•×‘ ×‘×•×˜×™×§×™ ×™×™×—×•×“×™ ×¢× ×’×•×•× ×™× ××“×•×ž×™×
- ××•×•×™×¨×” ××™× ×˜×™×ž×™×ª ×•×ž×™×•×—×“×ª
- ×¦×•×•×ª ×“×•×‘×¨ ×¢×‘×¨×™×ª, ×× ×’×œ×™×ª, ×¨×•×¡×™×ª
- ×ž×ª××™× ×‘×ž×™×•×—×“ ×œ×–×•×’×•×ª ×•× ×•×¡×¢×™× ×¢×¡×§×™×™×
- ×§×¨×•×‘ ×œ×—×™×™ ×”×œ×™×œ×” ×”×ª×•×¡×¡×™× ×©×œ ×ª×œ ××‘×™×‘
`;

const systemPrompt = `××ª×” ×¢×•×–×¨ AI ×—×›× ×•×ž×§×¦×•×¢×™ ×©×œ ×ž×œ×•×Ÿ Scarlet ×ª×œ ××‘×™×‘.

×ª×¤×§×™×“×š:
- ×œ×¢× ×•×ª ×¢×œ ×©××œ×•×ª ××•×¨×—×™× ×‘×¦×•×¨×” ×™×“×™×“×•×ª×™×ª ×•×ž×§×¦×•×¢×™×ª
- ×œ×¡×¤×§ ×ž×™×“×¢ ×ž×“×•×™×§ ×¢×œ ×”×ž×œ×•×Ÿ, ×”×—×“×¨×™×, ×”×ž×—×™×¨×™× ×•×”×©×™×¨×•×ª×™×
- ×œ×¢×–×•×¨ ×‘××•×¨×—×™× ×œ×‘×—×•×¨ ××ª ×”×—×“×¨ ×”×ž×ª××™× ×œ×”×
- ×œ×¢×•×“×“ ×”×–×ž× ×•×ª ×•×œ×¡×¤×§ ×§×™×©×•×¨ ×œ×”×–×ž× ×”
- ×œ×¢× ×•×ª ×‘×¢×‘×¨×™×ª ××• ×‘×× ×’×œ×™×ª ×‘×”×ª×× ×œ×©×¤×ª ×”×©×•××œ

×”× ×—×™×•×ª:
- ×ª×ž×™×“ ×”×™×” ××“×™×‘, ×ž×§×¦×•×¢×™ ×•×™×“×™×“×•×ª×™
- ×”×©×ª×ž×© ×‘×ž×™×“×¢ ×ž×”-knowledge base ×‘×œ×‘×“
- ×× ××ª×” ×œ× ×™×•×“×¢ ×ž×©×”×•, ××ž×•×¨ ×©×ª×‘×“×•×§ ×•×ª×—×–×•×¨ ×¢× ×ª×©×•×‘×”
- ×¢×•×“×“ ×”×–×ž× ×•×ª ××‘×œ ××œ ×ª×”×™×” ×œ×•×—×¥ ×ž×“×™
- ×”×©×ª×ž×© ×‘××™×ž×•×’'×™ ×‘×ž×™×“×” (×œ× ×™×•×ª×¨ ×ž×“×™)
- ×ª×Ÿ ×ª×©×•×‘×•×ª ×§×¦×¨×•×ª ×•×ž×ž×•×§×“×•×ª
- ×× ×©×•××œ×™× ×¢×œ ×ž×—×™×¨, ×¦×™×™×Ÿ "×”×—×œ ×ž-" ×•×¢×•×“×“ ×œ×™×¦×•×¨ ×§×©×¨ ×œ×¤×¨×˜×™× ×ž×“×•×™×§×™×

×“×•×’×ž××•×ª ×œ×ª×©×•×‘×•×ª ×˜×•×‘×•×ª:
- "×©×œ×•×! ðŸ‘‹ ××©×ž×— ×œ×¢×–×•×¨ ×œ×š ×œ×ž×¦×•× ××ª ×”×—×“×¨ ×”×ž×•×©×œ× ×‘×ž×œ×•×Ÿ Scarlet"
- "×”×ž×œ×•×Ÿ ×©×œ× ×• × ×ž×¦× ×‘×ž×™×§×•× ×ž×¢×•×œ×”, ×¨×§ 5 ×“×§×•×ª ×”×œ×™×›×” ×ž×—×•×£ ×’×•×¨×“×•×Ÿ ðŸ–ï¸"
- "×”×—×“×¨ ×”×§×œ××¡×™×§ ×¢× ×ž×¨×¤×¡×ª ×ž×ª×—×™×œ ×ž-â‚ª650 ×œ×œ×™×œ×”. ×¨×•×¦×” ×©××¢×–×•×¨ ×œ×š ×œ×”×–×ž×™×Ÿ?"

×–×›×•×¨: ××ª×” ×ž×™×™×¦×’ ××ª ×”×ž×œ×•×Ÿ, ××– ×ª×ž×™×“ ×”×™×” ×—×™×•×‘×™ ×•×ž×•×¢×™×œ!`;

async function startServer() {
  const app = express();
  const server = createServer(app);

  // Enable JSON parsing for API requests
  app.use(express.json());

  // Chat API endpoint
  app.post("/api/chat", async (req, res) => {
    try {
      const apiKey = process.env.OPENAI_API_KEY;
      if (!apiKey) {
        return res.status(500).json({
          error: "API key not configured",
          message: "×ž×¤×ª×— API ×œ× ×”×•×’×“×¨. ×× × ×¤× ×” ×œ×ž× ×”×œ ×”××ª×¨.",
        });
      }

      const { messages, userMessage } = req.body;

      if (!userMessage) {
        return res.status(400).json({
          error: "Missing message",
          message: "×—×¡×¨×” ×”×•×“×¢×”",
        });
      }

      const openai = new OpenAI({ apiKey });

      const response = await openai.chat.completions.create({
        model: "gpt-4o-mini",
        messages: [
          {
            role: "system",
            content: systemPrompt + "\n\nKnowledge Base:\n" + hotelKnowledge,
          },
          ...(messages || []).map((msg: { role: string; content: string }) => ({
            role: msg.role,
            content: msg.content,
          })),
          {
            role: "user",
            content: userMessage,
          },
        ],
        temperature: 0.7,
        max_tokens: 500,
      });

      const assistantMessage =
        response.choices[0]?.message?.content ||
        "×ž×¦×˜×¢×¨, ×œ× ×”×¦×œ×—×ª×™ ×œ×”×‘×™×Ÿ. × ×¡×” ×©×•×‘.";

      res.json({ message: assistantMessage });
    } catch (err: any) {
      console.error("Chat API error:", err);

      let errorMessage = "×ž×¦×˜×¢×¨, ××™×¨×¢×” ×©×’×™××”. ×× × × ×¡×” ×©×•×‘ ×ž××•×—×¨ ×™×•×ª×¨.";

      if (err.status === 429) {
        errorMessage = "×™×•×ª×¨ ×ž×“×™ ×‘×§×©×•×ª. ×× × ×”×ž×ª×Ÿ ×¨×’×¢ ×•× ×¡×” ×©×•×‘.";
      } else if (err.status === 401) {
        errorMessage = "×ž×¤×ª×— API ×œ× ×ª×§×™×Ÿ. ×× × ×¤× ×” ×œ×ž× ×”×œ ×”××ª×¨.";
      }

      res.status(err.status || 500).json({
        error: err.message,
        message: errorMessage,
      });
    }
  });

  // Serve static files from dist/public in production
  const staticPath =
    process.env.NODE_ENV === "production"
      ? path.resolve(__dirname, "public")
      : path.resolve(__dirname, "..", "dist", "public");

  app.use(express.static(staticPath));

  // Handle client-side routing - serve index.html for all routes
  app.get("*", (_req, res) => {
    res.sendFile(path.join(staticPath, "index.html"));
  });

  const port = process.env.PORT || 3000;

  server.listen(port, () => {
    console.log(`Server running on http://localhost:${port}/`);
  });
}

startServer().catch(console.error);
